<form [formGroup]="bordereauForm" (ngSubmit)="onSubmit()" class="space-y-8">
  <!-- Page Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">
        Créer un Nouveau Bordereau
      </h1>
      <p class="mt-1 text-gray-500">
        Remplissez les informations du bordereau et ajoutez les ordres de
        recette.
      </p>
    </div>
  </div>

  <!-- Section 1: Informations Générales du Bordereau -->
  <div class="p-6 bg-white rounded-lg shadow-sm">
    <h2
      class="text-xl font-semibold text-gray-700 border-b border-gray-100 pb-3 mb-6"
    >
      Informations Générales
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <!-- Ordonnateur -->
      <div>
        <label for="ordonnateur" class="block text-sm font-medium text-gray-700"
          >Ordonnateur</label
        >
        <input
          type="text"
          id="ordonnateur"
          formControlName="ordonnateur"
          class="w-full px-3 py-2 mt-1 text-gray-800 bg-gray-50 border border-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-[#187181]"
        />
      </div>
      <!-- Nature Budget -->
      <div>
        <label
          for="natureBudget"
          class="block text-sm font-medium text-gray-700"
          >Nature Budget</label
        >
        <select
          id="natureBudget"
          formControlName="natureBudget"
          class="w-full px-3 py-2 mt-1 text-gray-800 bg-gray-50 border border-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-[#187181]"
        >
          <option value="" disabled>Sélectionner...</option>
          <option value="Budget d'État">Budget d'État</option>
          <option value="Budget EPA">Budget EPA</option>
          <option value="Budget Wilaya">Budget Wilaya</option>
          <option value="Comptes Spéciaux">Comptes Spéciaux</option>
        </select>
      </div>
      <!-- Type -->
      <div>
        <label for="type" class="block text-sm font-medium text-gray-700"
          >Type</label
        >
        <select
          id="type"
          formControlName="type"
          class="w-full px-3 py-2 mt-1 text-gray-800 bg-gray-50 border border-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-[#187181]"
        >
          <option value="Prise en charge">Prise en charge</option>
          <option value="Réduction">Réduction</option>
          <option value="Non-valeur">Non-valeur</option>
        </select>
      </div>
      <!-- Date Prise en Charge -->
      <div>
        <label
          for="datePriseEnCharge"
          class="block text-sm font-medium text-gray-700"
          >Date Prise en Charge</label
        >
        <input
          type="date"
          id="datePriseEnCharge"
          formControlName="datePriseEnCharge"
          class="w-full px-3 py-2 mt-1 text-gray-800 bg-gray-50 border border-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-[#187181]"
        />
      </div>
    </div>
  </div>

  <!-- Section 2: Ordres de Recette (FormArray) -->
  <div class="space-y-6" formArrayName="ordres">
    <h2 class="text-xl font-semibold text-gray-700">Ordres de Recette</h2>
    <!-- Loop over each 'Ordre' FormGroup in the 'ordres' FormArray -->
    <div
      *ngFor="let ordreGroup of ordres.controls; let i = index"
      [formGroupName]="i"
      class="p-6 bg-white rounded-lg shadow-sm border border-gray-100"
    >
      <div
        class="flex items-center justify-between pb-3 mb-4 border-b border-gray-100"
      >
        <h3 class="font-semibold text-gray-800">
          Ordre de Recette #{{ i + 1 }}
        </h3>
        <button
          type="button"
          (click)="removeOrdre(i)"
          title="Supprimer cet ordre"
          class="p-1 text-red-600 rounded hover:bg-red-100"
        >
          <svg
            class="w-5 h-5"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"
            />
          </svg>
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <input
          type="text"
          formControlName="numeroOrdre"
          placeholder="Numéro de l'ordre"
          class="w-full px-3 py-2 text-gray-800 bg-gray-50 border border-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-[#187181]"
        />
        <app-redevable-lookup
          formControlName="redevableId"
        ></app-redevable-lookup>
      </div>

      <!-- Section 2.1: Lignes de Recette (Nested FormArray) -->
      <div
        class="mt-6 pl-4 border-l-2 border-gray-100 space-y-4"
        formArrayName="lignes"
      >
        <h4 class="text-md font-semibold text-gray-600">Lignes de l'Ordre</h4>
        <!-- Loop over each 'Ligne' FormGroup in the nested 'lignes' FormArray -->
        <div
          *ngFor="let ligneGroup of lignes(i).controls; let j = index"
          [formGroupName]="j"
          class="flex items-center gap-4"
        >
          <input
            type="text"
            formControlName="categorie"
            placeholder="Catégorie (ex: Ligne TR5)"
            class="flex-1 px-3 py-2 text-gray-800 bg-white border border-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-[#187181]"
          />
          <input
            type="number"
            formControlName="montant"
            placeholder="Montant"
            class="w-48 px-3 py-2 text-gray-800 bg-white border border-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-[#187181]"
          />
          <button
            type="button"
            (click)="removeLigne(i, j)"
            title="Supprimer cette ligne"
            class="p-1 text-red-500 rounded hover:bg-red-100"
          >
            <svg
              class="w-5 h-5"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M19.5 12h-15"
              />
            </svg>
          </button>
        </div>
        <button
          type="button"
          (click)="addLigne(i)"
          class="flex items-center gap-2 px-3 py-1 text-sm font-medium text-[#187181] rounded-md hover:bg-teal-50"
        >
          <svg
            class="w-4 h-4"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 4.5v15m7.5-7.5h-15"
            />
          </svg>
          Ajouter une Ligne
        </button>
      </div>
    </div>

    <!-- Button to add a new 'Ordre' -->
    <button
      type="button"
      (click)="addOrdre()"
      class="w-full flex items-center justify-center gap-2 px-4 py-2 font-semibold text-[#187181] transition-colors bg-white border-2 border-dashed border-gray-100 rounded-lg hover:bg-gray-50 hover:border-[#187181]"
    >
      <svg
        class="w-5 h-5"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="2"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 4.5v15m7.5-7.5h-15"
        />
      </svg>
      Ajouter un Ordre de Recette
    </button>
  </div>

  <!-- Section 3: Final Actions -->
  <div
    class="flex items-center justify-end gap-4 pt-4 border-t border-gray-300"
  >
    <a
      [routerLink]="['/bordereaux']"
      class="px-6 py-2 font-semibold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200"
      >Annuler</a
    >
    <button
      type="submit"
      class="px-6 py-2 font-semibold text-white bg-[#187181] rounded-lg hover:opacity-90 disabled:opacity-50"
      [disabled]="!bordereauForm.valid"
    >
      Soumettre le Bordereau
    </button>
  </div>
</form>
